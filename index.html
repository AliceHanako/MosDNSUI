<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MosDNS 服务监控</title>

    <!-- Favicon / 网站图标 -->
    <link rel="icon" type="image/png" href="/static/favicon.png">
    <link rel="apple-touch-icon" href="/static/favicon.png">

    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- Chart.js 和 datalabels 插件 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

    <style>
        /* CSS Variables for theming */
        :root {
            --bg-color: #f7f9fd; /* Light blueish background */
            --text-color: #2c3e50; /* Darker text */
            --card-bg: #ffffff;
            --card-shadow: 0 8px 20px rgba(0, 0, 0, 0.08); /* Softer, deeper shadow */
            --border-color: #e0e6ec; /* Lighter border */
            --accent-color: #4a90e2; /* A modern blue */
            --error-color: #e74c3c;
            --label-color: #7f8c8d; /* Muted label */
            --value-color: #34495e; /* Stronger value */
            --control-bg: #f0f4f7;
            --control-border: #d5dce2;
            --control-text: #5e727e;
            --control-hover-bg: #e5edf3;
            --control-active-bg: var(--accent-color);
            --control-active-text: #ffffff;
            --toggle-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);

            /* Status Dot Colors */
            --status-green: #2ecc71;
            --status-yellow: #f1c40f;
            --status-red: #e74c3c;

            /* Gradient Colors */
            --gradient-start: #4a90e2;
            --gradient-mid: #2e86de;
            --gradient-end: #4a90e2;

            /* Border Radii */
            --radius-main: 1rem; /* Slightly larger radius */
            --radius-bar: 0.2rem;
            --radius-control: 0.5rem; /* For buttons and toggles */

            /* Chart Colors */
            --chart-color-hit: rgba(74, 144, 226, 0.7);
            --chart-color-miss: rgba(189, 195, 199, 0.3); /* Lighter gray for miss */
            --chart-border-hit: var(--accent-color);
            --chart-border-miss: #bdc3c7;
        }

        /* --- Theme: Dark (Default Dark) --- */
        body.theme-dark {
            --bg-color: #1a1a1a; /* Cleaner, very dark gray */
            --text-color: #e0e0e0;
            --card-bg: #282828; /* Slightly lighter card background for contrast */
            --card-shadow: 0 8px 25px rgba(0, 0, 0, 0.5); /* Deeper shadow */
            --border-color: #3a3a3a;
            --label-color: #bbbbbb; /* Lighter for readability */
            --value-color: #ffffff; /* Pure white for values */
            --control-bg: #353535;
            --control-border: #4a4a4a;
            --control-text: #e0e0e0;
            --control-hover-bg: #404040;
            --control-active-bg: #555555; /* A more neutral dark grey for active state */
            --control-active-text: #ffffff;
            --gradient-start: #5096ff; /* Brighter blue gradient for dark mode */
            --gradient-mid: #3a7ce0;
            --gradient-end: #5096ff;
            --chart-color-hit: rgba(80, 150, 255, 0.7); /* Brighter blue for hit in dark mode */
            --chart-color-miss: rgba(100, 100, 100, 0.3);
            --chart-border-hit: #5096ff;
            --chart-border-miss: #707070;
        }

        /* --- Theme: Cyberpunk --- */
        body.theme-cyberpunk {
            --bg-color: #0c0221;
            --text-color: #e0e1dd;
            --card-bg: #1a0f3d;
            --card-shadow: 0 10px 30px rgba(42, 7, 102, 0.6);
            --border-color: #3b2a60;
            --accent-color: #00f6ff; /* Cyan */
            --error-color: #ff005c; /* Magenta */
            --label-color: #a9a2c1;
            --value-color: #f0f0f0;
            --gradient-start: #00f6ff;
            --gradient-mid: #ff005c;
            --gradient-end: #00f6ff;
            --control-bg: #1e114d;
            --control-border: #4a3a79;
            --control-text: #a0a0e0;
            --control-hover-bg: #2e1e5d;
            --control-active-bg: #00f6ff;
            --control-active-text: #0c0221;
            --chart-color-hit: rgba(0, 246, 255, 0.7);
            --chart-color-miss: rgba(255, 0, 92, 0.3);
            --chart-border-hit: #00f6ff;
            --chart-border-miss: #ff005c;
        }

        /* --- Theme: Forest --- */
        body.theme-forest {
            --bg-color: #e8f5e9;
            --text-color: #2e3d32;
            --card-bg: #ffffff;
            --card-shadow: 0 6px 18px rgba(0, 0, 0, 0.06);
            --border-color: #d0e0d0;
            --accent-color: #4a7c59; /* Forest Green */
            --error-color: #c0392b;
            --label-color: #607b6c;
            --value-color: #2e3d32;
            --gradient-start: #4a7c59;
            --gradient-mid: #3a6246;
            --gradient-end: #4a7c59;
            --control-bg: #e1f0e2;
            --control-border: #c8d8c8;
            --control-text: #506f5c;
            --control-hover-bg: #d6e8d7;
            --control-active-bg: #4a7c59;
            --control-active-text: #ffffff;
            --chart-color-hit: rgba(74, 124, 89, 0.7);
            --chart-color-miss: rgba(160, 180, 165, 0.3);
            --chart-border-hit: #4a7c59;
            --chart-border-miss: #a0a0a0;
        }

        /* --- Theme: Sunset --- */
        body.theme-sunset {
            --bg-color: #2c203a;
            --text-color: #fde8d7;
            --card-bg: #3a2a4e;
            --card-shadow: 0 10px 30px rgba(44, 32, 58, 0.6);
            --border-color: #553e70;
            --accent-color: #ff8c42; /* Orange */
            --error-color: #e74c3c;
            --label-color: #d3b7e8;
            --value-color: #fde8d7;
            --gradient-start: #ff8c42;
            --gradient-mid: #ff4d6d;
            --gradient-end: #ff8c42;
            --control-bg: #4a3360;
            --control-border: #5c4278;
            --control-text: #e0c8f5;
            --control-hover-bg: #5a4370;
            --control-active-bg: #ff8c42;
            --control-active-text: #2c203a;
            --chart-color-hit: rgba(255, 140, 66, 0.7);
            --chart-color-miss: rgba(255, 77, 109, 0.3);
            --chart-border-hit: #ff8c42;
            --chart-border-miss: #ff4d6d;
        }

        /* --- Theme: Monochrome --- */
        body.theme-monochrome {
            --bg-color: #eef1f4;
            --text-color: #2b2e31;
            --card-bg: #ffffff;
            --card-shadow: 0 6px 18px rgba(0, 0, 0, 0.07);
            --border-color: #d8dee3;
            --accent-color: #4a4a4a; /* Deeper gray for accent */
            --error-color: #b00020;
            --label-color: #7f8c8d;
            --value-color: #1a1a1a;
            --gradient-start: #666666;
            --gradient-mid: #333333;
            --gradient-end: #666666;
            --control-bg: #e1e4e7;
            --control-border: #c9ccd0;
            --control-text: #5e6872;
            --control-hover-bg: #d6dbdf;
            --control-active-bg: #4a4a4a;
            --control-active-text: #ffffff;
            --chart-color-hit: rgba(74, 74, 74, 0.7);
            --chart-color-miss: rgba(160, 160, 160, 0.3);
            --chart-border-hit: #4a4a4a;
            --chart-border-miss: #a0a0a0;
        }

        /* Base styles */
        html {
            font-size: 16px;
        }
        body {
            font-family: 'SF Pro Text', 'system-ui', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
            margin: 0;
            padding: 2rem; /* Increased padding */
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6; /* Slightly increased line height */
            transition: background-color 0.4s ease-in-out, color 0.4s ease-in-out;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-sizing: border-box;
        }

        .header {
            text-align: center;
            width: 100%;
            max-width: 1200px;
            margin-bottom: 2rem;
            position: relative;
        }

        .header h1 {
            font-size: 2.5rem; /* Larger title */
            color: var(--accent-color);
            margin: 0 0 0.8rem 0; /* More spacing */
            font-weight: 700;
            letter-spacing: -0.03em; /* Tighter letter spacing for title */
        }
        .header-gradient-bar {
            width: 100%;
            max-width: 160px; /* Wider bar */
            height: 5px; /* Thicker bar */
            border-radius: var(--radius-bar);
            background-image: linear-gradient(to right, var(--gradient-start), var(--gradient-mid), var(--gradient-end));
            margin: 0 auto 1.5rem auto;
            transition: background-image 0.4s ease-in-out;
        }

        /* Theme Toggle Buttons (now in footer) */
        .theme-selector {
            display: flex;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
            gap: 0.5rem; /* Gap between buttons */
            /* Removed fixed positioning styles */
            background-color: var(--control-bg); /* Use control background */
            border: 1px solid var(--control-border); /* Use control border */
            border-radius: var(--radius-control);
            box-shadow: var(--toggle-shadow);
            overflow: hidden;
            padding: 0.5rem; /* Padding for the container */
            justify-content: center; /* Center buttons within its container */
        }
        .theme-selector button {
            background: none;
            border: none;
            padding: 0.6rem 0.9rem;
            color: var(--control-text);
            font-size: 0.9rem;
            cursor: pointer;
            outline: none;
            transition: background-color 0.2s ease, color 0.2s ease, transform 0.1s ease-out;
            border-radius: var(--radius-control); /* Apply radius to individual buttons */
            flex-grow: 1; /* Allow buttons to grow */
            min-width: 90px; /* Ensure a minimum width for buttons */
        }
        .theme-selector button:hover {
            background-color: var(--control-hover-bg);
        }
        .theme-selector button.active {
            background-color: var(--control-active-bg);
            color: var(--control-active-text);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }
        /* No border-right needed if buttons have gap and individual border-radius */
        .theme-selector button i {
            margin-right: 0.3em;
        }

        .main-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(380px, 1fr)); /* Auto-fit columns, slightly wider min */
            gap: 1.5rem; /* Increased gap */
            width: 100%;
            max-width: 1400px;
            flex-grow: 1;
            margin-bottom: 2rem; /* Space before footer */
        }

        .card {
            background-color: var(--card-bg);
            border-radius: var(--radius-main);
            box-shadow: var(--card-shadow);
            padding: 1.8rem; /* More padding inside cards */
            display: none; /* Initially hidden */
            flex-direction: column;
            box-sizing: border-box;
            transition: all 0.3s ease-in-out;
            border: 1px solid var(--border-color);
            transform: translateY(0); /* Ensure smooth hover */
        }
        .card.visible {
            display: flex;
        }
        .card:hover {
            transform: translateY(-0.35rem); /* Slightly more pronounced lift */
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.12); /* Enhanced hover shadow */
        }
        .card-content {
            display: flex;
            flex-direction: row;
            gap: 2rem; /* Increased gap within card */
            flex-grow: 1;
        }

        h2, h3 {
            color: var(--text-color);
            border-bottom: none;
            padding-bottom: 0;
            margin-top: 0;
            margin-bottom: 0.6rem; /* More margin */
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.6rem; /* More gap for icon */
        }
        h2 { font-size: 1.6rem; } /* Slightly larger */
        h3 { font-size: 1.3rem; border-bottom: 1px solid var(--border-color); padding-bottom: 0.6rem; margin-bottom: 1rem; }

        h2 .title-text {
            flex-grow: 1;
            text-align: left;
        }
        h2 .status-dot {
            width: 0.6rem; /* Slightly larger dot */
            height: 0.6rem;
            border-radius: 50%;
            transition: background-color 0.3s ease-in-out;
            flex-shrink: 0;
        }
        h2 .status-dot.status-green { background-color: var(--status-green); }
        h2 .status-dot.status-yellow { background-color: var(--status-yellow); }

        .card-title-gradient-bar {
            width: 100%;
            height: 4px; /* Thicker bar */
            border-radius: var(--radius-bar);
            background-image: linear-gradient(to right, var(--gradient-start), var(--gradient-mid), var(--gradient-end));
            margin-bottom: 1.2rem;
            transition: background-image 0.4s ease-in-out;
        }

        .metrics-container {
            flex: 1;
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 0.6rem 1.2rem; /* More space */
            align-items: baseline;
        }
        .metrics-container p {
            margin: 0; /* Remove default paragraph margin */
            font-size: 1.05rem; /* Slightly larger text */
            display: contents;
        }
        .label {
            font-weight: 500;
            color: var(--label-color);
            text-align: right;
            padding-right: 0.6rem;
        }
        .value {
            color: var(--value-color);
            font-weight: 600;
            text-align: left;
        }
        .value.accent {
            color: var(--accent-color);
            font-weight: 700; /* More emphasis */
        }

        .charts {
            display: flex;
            flex-direction: column;
            gap: 1.2rem; /* More gap between charts */
            flex-shrink: 0;
            align-items: center; /* Center charts */
        }
        .chart-container {
            position: relative;
            width: 140px; /* Slightly larger charts */
            height: 140px;
            background-color: var(--card-bg); /* Ensure chart background matches card */
            border-radius: var(--radius-main); /* Match card radius */
            padding: 0.5rem; /* Padding for chart */
            box-sizing: border-box;
        }

        /* Footer Panel */
        .footer-panel {
            width: 100%;
            max-width: 1400px;
            display: grid;
            /* Now 4 potential columns */
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); /* Adjusted min-width for 4 columns */
            gap: 2rem; /* Increased gap */
            margin-top: auto; /* Push to bottom */
            padding: 1.8rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-main);
            background-color: var(--card-bg);
            box-shadow: var(--card-shadow);
            align-items: flex-start;
        }

        /* Common styling for control groups in footer */
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            align-items: flex-start;
        }
        /* Specific tweaks for inner elements */
        .toggle-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); /* Better toggle layout */
            gap: 0.8rem;
            width: 100%; /* Fill available space */
        }
        .toggle-group label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            font-size: 0.95rem;
            padding: 0.5rem 0.8rem; /* Padding for toggle label area */
            background-color: var(--control-bg);
            border: 1px solid var(--control-border);
            border-radius: var(--radius-control);
            transition: all 0.2s ease;
            color: var(--control-text);
        }
        .toggle-group label:hover {
            background-color: var(--control-hover-bg);
            border-color: var(--accent-color);
        }
        .toggle-group input[type="checkbox"] {
            /* Hide default checkbox */
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            width: 18px;
            height: 18px;
            border: 2px solid var(--control-border);
            border-radius: 4px;
            background-color: var(--card-bg);
            position: relative;
            cursor: pointer;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }
        .toggle-group input[type="checkbox"]:checked {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
        }
        .toggle-group input[type="checkbox"]:checked::after {
            content: '\2713'; /* Checkmark unicode character */
            display: block;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 14px;
            color: white;
        }

        .action-buttons {
            display: flex;
            gap: 1.2rem; /* More space between buttons */
            align-items: center;
            flex-wrap: wrap;
            margin-top: 0.5rem;
            width: 100%; /* Ensure it takes full width within its parent */
            justify-content: flex-start; /* Default to start alignment */
        }
        /* Specific alignment for the refresh control group */
        .refresh-control-group .action-buttons {
            flex-direction: column; /* Stack buttons vertically */
            gap: 0.8rem;
            align-items: flex-start; /* Align stacked items to the left */
        }
        .action-buttons button {
            padding: 0.7rem 1.4rem; /* Larger buttons */
            border-radius: var(--radius-control);
            border: 1px solid var(--control-border);
            background-color: var(--control-bg);
            color: var(--control-text);
            font-size: 0.95rem;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            outline: none;
            display: inline-flex; /* For icon + text alignment */
            align-items: center;
            gap: 0.5rem; /* Space between icon and text */
            width: auto; /* Allow buttons to take natural width */
        }
        /* Make immediate refresh button span full width if needed */
        .refresh-control-group .action-buttons #refresh-now-btn {
            width: 100%; /* Full width for refresh button */
            justify-content: center; /* Center content within full width button */
        }
        /* And flush cache button too */
        .refresh-control-group .action-buttons #flush-cache-btn {
             width: 100%; /* Full width for flush button */
             justify-content: center;
        }

        .action-buttons button:hover {
            background-color: var(--control-hover-bg);
            border-color: var(--accent-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .action-buttons button.primary {
            background-color: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }
        .action-buttons button.primary:hover {
            background-color: var(--gradient-mid);
            border-color: var(--gradient-mid);
        }
        span#last_updated {
            font-size: 0.9rem;
            color: var(--label-color);
            margin-left: 0; /* Reset margin from previous auto-left */
            text-align: left; /* Default to left align */
            width: 100%; /* Take full width below buttons */
        }

        .error {
            color: var(--error-color);
            font-weight: bold;
            background-color: rgba(231, 76, 60, 0.1);
            border: 1px solid var(--error-color);
            padding: 1.5rem;
            border-radius: var(--radius-main);
            margin-top: 2rem;
        }

        /* Loading Spinner */
        #loading-spinner {
            display: none;
            width: 40px;
            height: 40px;
            border: 4px solid var(--border-color);
            border-top-color: var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 4rem auto;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .loading #loading-spinner {
            display: block;
        }
        .loading #main-content, .loading .footer-panel {
            opacity: 0.5;
            pointer-events: none;
        }

        /* Responsive */
        @media (max-width: 1280px) {
            .main-container {
                grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); /* Slightly smaller min-width */
            }
        }
        @media (max-width: 992px) {
            body { padding: 1.5rem; }
            .header { margin-bottom: 1.5rem; }
            /* Footer grid layout for medium screens */
            .footer-panel {
                grid-template-columns: 1fr; /* Stack all columns on smaller screens */
                gap: 1.5rem;
            }
            .card { padding: 1.5rem; }
            .footer-panel { padding: 1.5rem; }
            .action-buttons {
                justify-content: center; /* Center buttons on smaller screens */
            }
            /* Specific alignment for the refresh control group */
            .refresh-control-group .action-buttons {
                align-items: center; /* Center stacked items for smaller screens */
            }
            span#last_updated {
                margin-left: 0; /* Reset margin on smaller screens */
                text-align: center;
                width: 100%;
            }
            .control-group { /* Target all control groups */
                align-items: center; /* Center content */
            }
            .toggle-group {
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
                justify-content: center;
            }
        }

        @media (max-width: 768px) {
            html { font-size: 15px; } /* Base font smaller */
            body { padding: 1rem; }
            .header h1 { font-size: 2rem; margin-bottom: 0.5rem; }
            .header-gradient-bar { max-width: 120px; height: 4px; margin-bottom: 1rem; }
            .card, .footer-panel { padding: 1rem; border-radius: 0.8rem; }
            h2 { font-size: 1.4rem; margin-bottom: 0.3rem; }
            h3 { font-size: 1.2rem; padding-bottom: 0.4rem; margin-bottom: 0.7rem; }
            .card-content { flex-direction: column; gap: 1rem; }
            .metrics-container {
                grid-template-columns: 1fr; /* Stack labels and values */
                gap: 0.4rem;
            }
            .metrics-container p {
                display: block;
                line-height: 1.3;
            }
            .label, .value {
                text-align: left;
                display: inline;
                padding-right: 0;
            }
            .label::after {
                content: ': ';
            }
            .charts {
                flex-direction: row;
                justify-content: space-around;
                flex-wrap: wrap; /* Allow charts to wrap */
            }
            .chart-container { width: 110px; height: 110px; padding: 0.3rem;}
        }

        @media (max-width: 480px) {
            html { font-size: 14px; }
            .header h1 { font-size: 1.8rem; }
            .header-gradient-bar { max-width: 90px; height: 3px; }
            .card { padding: 0.8rem; }
            .charts { gap: 0.8rem; }
            .chart-container { width: 90px; height: 90px; }
            .toggle-group { grid-template-columns: 1fr; } /* Stack toggles */
            .action-buttons button { padding: 0.6rem 1rem; font-size: 0.85rem; }
            .theme-selector button { min-width: unset; } /* Allow buttons to shrink further */
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>MosDNS 监控面板</h1>
        <div class="header-gradient-bar"></div>
    </div>

    <div id="loading-spinner"></div>

    <div id="main-content" class="main-container">
        <!-- Cache cards will be populated by JS -->
    </div>

    <div class="footer-panel">
        <div class="system-info-container control-group"> <!-- Added control-group for consistent styling -->
            <h3><i class="fas fa-server"></i> 系统信息</h3>
            <div class="metrics-container" id="metrics-system"></div>
        </div>

        <div class="card-toggle-container control-group">
            <h3><i class="fas fa-eye"></i> 显示卡片</h3>
            <div class="toggle-group" id="card-toggles">
                <!-- Toggles will be generated by JS -->
            </div>
        </div>
        
        <div class="theme-control-group control-group">
            <h3><i class="fas fa-palette"></i> 主题切换</h3>
            <div class="theme-selector" id="theme-selector">
                <!-- Theme buttons will be populated by JS -->
            </div>
        </div>

        <!-- Combined Refresh & Cache control group -->
        <div class="refresh-cache-control-group control-group">
            <h3><i class="fas fa-tools"></i> 操作与刷新</h3> <!-- Combined title -->
            <div class="toggle-group">
                <label>
                    <input type="checkbox" id="auto-refresh-toggle"> 启用自动刷新 (5s)
                </label>
            </div>
            <div class="action-buttons">
                <button id="refresh-now-btn" class="primary"><i class="fas fa-sync-alt"></i> 立即刷新</button>
                <button id="flush-cache-btn"><i class="fas fa-broom"></i> 清空 FakeIP 缓存</button>
                <span id="last_updated"><i class="fas fa-clock"></i> </span>
            </div>
        </div>
    </div>

    <script>
        const API_URL = '/api/mosdns_status';
        const FLUSH_ENDPOINT = '/api/flush_fakeip_cache';
        const REFRESH_INTERVAL = 5000;
        let chartInstances = {};
        let autoRefreshTimer;
        let isRefreshing = false; // Prevent multiple simultaneous fetches

        // --- 修复点：注册 Chart.js 插件 ---
        Chart.register(ChartDataLabels);

        // Helper function to create HTML elements
        function createElement(tag, className, innerText = '') {
            const el = document.createElement(tag);
            if (className) el.className = className;
            if (innerText) el.innerText = innerText;
            return el;
        }

        // Helper for number formatting
        function formatNumber(num) {
            if (typeof num !== 'number') {
                num = parseFloat(num);
                if (isNaN(num)) return num; // If it's truly not a number, return as is
            }
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            }
            if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toLocaleString();
        }

        // --- Theme handling ---
        const themeMap = {
            'light': { name: '默认亮色', icon: 'fa-sun' },
            'dark': { name: '默认暗色', icon: 'fa-moon' },
            'cyberpunk': { name: '赛博朋克', icon: 'fa-robot' },
            'forest': { name: '静谧森林', icon: 'fa-tree' },
            'sunset': { name: '日落余晖', icon: 'fa-cloud-sun-rain' },
            'monochrome': { name: '高级灰', icon: 'fa-grip-lines' }
        };
        const body = document.body; // Reference to the body element
        const themeSelector = document.getElementById('theme-selector'); // Now in the footer

        function setTheme(mode) {
            body.className = '';
            if (mode !== 'light') {
                body.classList.add(`theme-${mode}`);
            }
            localStorage.setItem('theme', mode);
            updateThemeButtons(mode); // Update active button state
            // Force rebuild and chart update to pick up new theme colors
            refreshData(true, true); 
        }

        function updateThemeButtons(activeMode) {
            themeSelector.innerHTML = ''; // Clear existing buttons
            for (const mode in themeMap) {
                const themeData = themeMap[mode];
                const button = createElement('button');
                button.dataset.theme = mode;
                button.innerHTML = `<i class="fas ${themeData.icon}"></i> ${themeData.name}`;
                if (mode === activeMode) {
                    button.classList.add('active');
                }
                button.addEventListener('click', () => setTheme(mode));
                themeSelector.appendChild(button);
            }
        }

        const savedTheme = localStorage.getItem('theme') || 'light';
        updateThemeButtons(savedTheme); // Initialize buttons
        if (savedTheme !== 'light') {
            body.classList.add(`theme-${savedTheme}`);
        }


        // --- Data Fetching and Parsing ---
        async function fetchData() {
            if (isRefreshing) return null; // Prevent multiple fetches
            isRefreshing = true;
            document.body.classList.add('loading'); // Show loading spinner

            try {
                const response = await fetch(API_URL);
                if (!response.ok) {
                    const errorDetails = await response.text();
                    throw new Error(`Network response was not ok: ${response.statusText} (${errorDetails})`);
                }
                return await response.json();
            } catch (error) {
                console.error('Error fetching data:', error);
                const mainContent = document.getElementById('main-content');
                if (mainContent) {
                    mainContent.innerHTML = `<p class="error" style="text-align:center; grid-column: 1 / -1; font-size: 1.2rem; padding: 2rem;">
                        <i class="fas fa-exclamation-triangle"></i> 无法连接到 MosDNS 的 API 接口。
                        <br>请确保 MosDNS 和此监控面板的后端服务正在运行，并且您从正确的地址访问此页面。
                        <br><small>${error.message}</small>
                    </p>`;
                }
                return null;
            } finally {
                isRefreshing = false;
                document.body.classList.remove('loading'); // Hide loading spinner
            }
        }

        // --- UI Rendering ---
        function createCacheCard(tag, title) {
            const card = createElement('div', 'card');
            card.dataset.tag = tag;

            const h2 = createElement('h2');
            const titleText = createElement('span', 'title-text', title);
            const statusDot = createElement('span', 'status-dot');
            statusDot.id = `status-dot-${tag}`;
            h2.append(createElement('i', 'fas fa-server'), titleText, statusDot); // Added icon

            const gradientBar = createElement('div', 'card-title-gradient-bar');

            const cardContent = createElement('div', 'card-content');

            const metricsContainer = createElement('div', 'metrics-container');
            metricsContainer.id = `metrics-${tag}`;

            const chartsContainer = createElement('div', 'charts');
            const totalHitChartContainer = createElement('div', 'chart-container');
            const lazyHitChartContainer = createElement('div', 'chart-container');
            const totalHitCanvas = createElement('canvas');
            const lazyHitCanvas = createElement('canvas');
            totalHitCanvas.id = `chart-hit-${tag}`;
            lazyHitCanvas.id = `chart-lazy-${tag}`;
            totalHitChartContainer.appendChild(totalHitCanvas);
            lazyHitChartContainer.appendChild(lazyHitCanvas);
            chartsContainer.append(totalHitChartContainer, lazyHitChartContainer);

            cardContent.append(metricsContainer, chartsContainer);
            card.append(h2, gradientBar, cardContent);
            return card;
        }

        function createOrUpdatePieChart(id, title, hit, total) {
            const ctx = document.getElementById(id);
            if (!ctx) return;

            const miss = Math.max(0, total - hit);
            const computedStyle = getComputedStyle(body); 

            const hitColor = computedStyle.getPropertyValue('--chart-color-hit').trim();
            const missColor = computedStyle.getPropertyValue('--chart-color-miss').trim();
            const hitBorder = computedStyle.getPropertyValue('--chart-border-hit').trim();
            const missBorder = computedStyle.getPropertyValue('--chart-border-miss').trim();
            const textColor = computedStyle.getPropertyValue('--text-color').trim();

            const data = {
                labels: ['命中', '未命中'],
                datasets: [{
                    data: [hit, miss],
                    backgroundColor: [hitColor, missColor],
                    borderColor: [hitBorder, missBorder],
                    borderWidth: 1.5
                }]
            };

            const options = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: { display: true, text: title, color: textColor, font: { size: 12, weight: 'bold' } },
                    legend: { display: false },
                    datalabels: {
                        formatter: (value, context) => {
                            const sum = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                            if (sum === 0) return value === 0 ? '' : `${value}`;
                            const percentage = (value / sum * 100);
                            return percentage > 5 ? `${percentage.toFixed(percentage < 10 ? 1 : 0)}%` : '';
                        },
                        color: textColor,
                        font: { weight: 'bold', size: 11 }
                    }
                },
                cutout: '70%',
            };

            if (chartInstances[id]) {
                chartInstances[id].data = data;
                chartInstances[id].options.plugins.title.color = textColor;
                chartInstances[id].options.plugins.datalabels.color = textColor;
                chartInstances[id].update('none'); // Update without animation for smoother refresh
            } else {
                chartInstances[id] = new Chart(ctx, { type: 'doughnut', data, options, plugins: [ChartDataLabels] });
            }
        }

        function updateMetrics(containerId, metricsData) {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = '';
            metricsData.forEach(metric => {
                const p = createElement('p');
                const labelSpan = createElement('span', 'label', metric.label);
                const valueSpan = createElement('span', 'value', metric.value);

                if (metric.numericValue !== undefined) {
                    valueSpan.innerText = formatNumber(metric.numericValue);
                } else if (metric.value.includes('%')) {
                    valueSpan.innerText = metric.value;
                } else {
                    valueSpan.innerText = metric.value;
                }

                if (metric.accent) valueSpan.classList.add('accent');
                p.append(labelSpan, valueSpan);
                container.appendChild(p);
            });
        }

        // --- Card Toggles Logic ---
        const cacheOrder = ['cache_all', 'cache_cn', 'cache_google', 'cache_node'];
        const cacheTitles = {
            'cache_all': '全部缓存', 'cache_cn': '国内缓存', 'cache_google': '国外缓存', 'cache_node': '节点缓存'
        };
        let visibleCards = JSON.parse(localStorage.getItem('visibleMosdnsCards')) || cacheOrder;

        function setupCardToggles() {
            const toggleContainer = document.getElementById('card-toggles');
            toggleContainer.innerHTML = '';
            cacheOrder.forEach(tag => {
                const label = createElement('label');
                const checkbox = createElement('input');
                checkbox.type = 'checkbox';
                checkbox.dataset.tag = tag;
                checkbox.checked = visibleCards.includes(tag);
                checkbox.addEventListener('change', handleToggleChange);
                label.append(checkbox, document.createTextNode(cacheTitles[tag]));
                toggleContainer.appendChild(label);
            });
        }
        function handleToggleChange(event) {
            const tag = event.target.dataset.tag;
            if (event.target.checked) {
                if (!visibleCards.includes(tag)) visibleCards.push(tag);
            } else {
                visibleCards = visibleCards.filter(t => t !== tag);
            }
            localStorage.setItem('visibleMosdnsCards', JSON.stringify(visibleCards));
            // Card visibility change requires full rebuild to show/hide elements cleanly
            refreshData(true, true); 
        }

        // --- Auto-refresh toggle logic ---
        const autoRefreshToggle = document.getElementById('auto-refresh-toggle');
        let autoRefreshEnabled = false;

        function startAutoRefresh() {
            if (autoRefreshTimer) clearInterval(autoRefreshTimer); // Clear existing timer first
            autoRefreshTimer = setInterval(() => {
                // For auto-refresh, we only update data and charts (if needed), no full rebuild
                refreshData(false, true); // updateCharts set to true here to keep charts updated
            }, REFRESH_INTERVAL);
            console.log('Auto-refresh started.');
        }

        function stopAutoRefresh() {
            if (autoRefreshTimer) {
                clearInterval(autoRefreshTimer);
                autoRefreshTimer = null;
                console.log('Auto-refresh stopped.');
            }
        }

        autoRefreshToggle.addEventListener('change', () => {
            autoRefreshEnabled = autoRefreshToggle.checked;
            localStorage.setItem('autoRefresh', autoRefreshEnabled);
            if (autoRefreshEnabled) {
                startAutoRefresh();
            } else {
                stopAutoRefresh();
            }
        });

        // --- Main Execution ---
        async function refreshData(forceRebuild = false, updateCharts = false) {
            const data = await fetchData();
            if (!data) {
                 // If data fetching failed, stop auto-refresh temporarily
                stopAutoRefresh();
                autoRefreshToggle.checked = false; // Uncheck toggle
                autoRefreshEnabled = false;
                localStorage.setItem('autoRefresh', false);
                return;
            } else if (autoRefreshEnabled && !autoRefreshTimer) {
                // If data fetching succeeded after failure, and auto-refresh is enabled, restart
                startAutoRefresh();
            }

            const mainContent = document.getElementById('main-content');

            if (forceRebuild) {
                // If rebuilding, clear all existing cards and destroy charts
                mainContent.innerHTML = '';
                Object.values(chartInstances).forEach(chart => chart.destroy());
                chartInstances = {};

                // Re-create cards for visible ones
                cacheOrder.forEach(tag => {
                    if (data.caches[tag] && visibleCards.includes(tag)) { // Only create if visible
                        mainContent.appendChild(createCacheCard(tag, cacheTitles[tag]));
                    }
                });
            }
            
            // Always update metrics and charts for visible cards (if updateCharts is true)
            cacheOrder.forEach(tag => {
                const card = mainContent.querySelector(`.card[data-tag="${tag}"]`);
                if (card) {
                    // Always set visibility class, regardless of forceRebuild
                    card.classList.toggle('visible', visibleCards.includes(tag));

                    if(visibleCards.includes(tag)) { // Only update if card is visible
                        const cardData = data.caches[tag];
                        updateMetrics(`metrics-${tag}`, [
                            { label: '请求总数', numericValue: cardData.query_total },
                            { label: '缓存命中', numericValue: cardData.hit_total },
                            { label: '过期缓存命中', numericValue: cardData.lazy_hit_total },
                            { label: '缓存命中率', value: cardData.hit_rate, accent: true },
                            { label: '过期缓存命中率', value: cardData.lazy_hit_rate, accent: true },
                            { label: '缓存条目数', numericValue: cardData.size_current },
                        ]);

                        const statusDot = document.getElementById(`status-dot-${tag}`);
                        if (statusDot) {
                            statusDot.classList.remove('status-green', 'status-yellow');
                            statusDot.classList.add(cardData.query_total > 0 ? 'status-green' : 'status-yellow');
                        }
                        if(updateCharts) { // Only update/create charts if explicitly requested
                            createOrUpdatePieChart(`chart-hit-${tag}`, '命中', cardData.hit_total, cardData.query_total);
                            createOrUpdatePieChart(`chart-lazy-${tag}`, '过期命中', cardData.lazy_hit_total, cardData.query_total);
                        }
                    }
                }
            });

            updateMetrics('metrics-system', [
                { label: '启动时间', value: data.system.start_time },
                { label: 'CPU 时间', value: data.system.cpu_time },
                { label: '常驻内存 (RSS)', value: data.system.resident_memory },
                { label: '待用堆内存 (Idle)', value: data.system.heap_idle_memory },
                { label: 'Go 版本', value: data.system.go_version, accent: true },
                { label: '线程数', numericValue: data.system.threads },
                { label: '打开文件描述符', numericValue: data.system.open_fds },
            ]);

            document.getElementById('last_updated').innerHTML = `<i class="fas fa-clock"></i> 最后更新: ${new Date().toLocaleTimeString()}`;
        }

        document.getElementById('refresh-now-btn').addEventListener('click', () => {
            // Manual refresh button should update data and charts
            refreshData(false, true); 
        });

        document.getElementById('flush-cache-btn').addEventListener('click', async () => {
            if (window.confirm("确定要清空 FakeIP 缓存吗？ (这将调用 /plugins/cache/flush 接口)")) {
                try {
                    const response = await fetch(FLUSH_ENDPOINT, { method: 'POST' });
                    if (response.ok) {
                        alert("FakeIP 缓存已清空！页面将刷新。");
                        // After flush, force a full rebuild and chart update
                        await refreshData(true, true);
                    } else {
                        const errorData = await response.json();
                        alert(`清空失败: ${errorData.error || response.statusText}`);
                    }
                } catch (error) {
                    console.error('清空缓存请求出错:', error);
                    alert(`请求出错: ${error.message}`);
                }
            }
        });
        
        // Initial setup on page load
        setupCardToggles();
        
        // Retrieve auto-refresh preference from localStorage
        const savedAutoRefresh = localStorage.getItem('autoRefresh');
        if (savedAutoRefresh === null) { // First time user, default to true
            autoRefreshEnabled = true;
        } else {
            autoRefreshEnabled = savedAutoRefresh === 'true';
        }
        autoRefreshToggle.checked = autoRefreshEnabled;

        // Initial data load: full rebuild and chart creation
        refreshData(true, true); 

        // Start auto-refresh if enabled
        if (autoRefreshEnabled) {
            startAutoRefresh();
        } else {
            stopAutoRefresh();
        }

    </script>
</body>
</html>
